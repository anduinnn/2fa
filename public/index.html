<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.jsdelivr.net 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' blob: data:; connect-src 'self'; media-src 'self' blob:;">
    <title>2FA Authenticator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Font Family */
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-mono: 'JetBrains Mono', 'SF Mono', Monaco, 'Courier New', monospace;

            /* Font Sizes */
            --text-xs: 11px;
            --text-sm: 13px;
            --text-base: 15px;
            --text-lg: 17px;
            --text-xl: 20px;
            --text-2xl: 24px;
            --text-code: 34px;

            /* Base Colors - Light Mode */
            --bg-primary: #F8FAFC;
            --bg-secondary: #EFF6FF;
            --bg-tertiary: #FFFFFF;

            /* Glass Effect */
            --glass-bg: rgba(255, 255, 255, 0.72);
            --glass-border: rgba(255, 255, 255, 0.5);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);

            /* Text Colors */
            --text-primary: #0F172A;
            --text-secondary: #475569;
            --text-tertiary: #94A3B8;
            --text-inverse: #FFFFFF;

            /* Border Colors */
            --border-default: rgba(15, 23, 42, 0.08);
            --border-hover: rgba(15, 23, 42, 0.16);

            /* Primary - Trust Blue */
            --primary: #2563EB;
            --primary-hover: #1D4ED8;
            --primary-light: #DBEAFE;
            --primary-glow: rgba(37, 99, 235, 0.24);

            /* Accent - Amber */
            --accent: #F59E0B;
            --accent-glow: rgba(245, 158, 11, 0.24);

            /* Status Colors */
            --success: #10B981;
            --success-light: #D1FAE5;
            --success-glow: rgba(16, 185, 129, 0.24);

            --danger: #EF4444;
            --danger-hover: #DC2626;
            --danger-light: #FEE2E2;
            --danger-glow: rgba(239, 68, 68, 0.24);

            /* Progress Ring */
            --ring-bg: rgba(15, 23, 42, 0.08);
            --ring-progress: var(--primary);
            --ring-warning: var(--accent);
            --ring-critical: var(--danger);

            /* Spacing */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 12px;
            --space-lg: 16px;
            --space-xl: 20px;
            --space-2xl: 24px;
            --space-3xl: 32px;

            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-full: 9999px;

            /* Transitions */
            --transition-fast: 150ms;
            --transition-normal: 200ms;
            --transition-slow: 300ms;

            /* Easing */
            --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
            --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);

            /* Legacy compatibility */
            --bg: var(--bg-primary);
            --card-bg: var(--bg-tertiary);
            --text: var(--text-primary);
            --border: var(--border-default);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                /* Base Colors - Dark Mode (OLED) */
                --bg-primary: #000000;
                --bg-secondary: #0A0A0A;
                --bg-tertiary: #111111;

                /* Glass Effect - Dark */
                --glass-bg: rgba(17, 17, 17, 0.8);
                --glass-border: rgba(255, 255, 255, 0.08);
                --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);

                /* Text Colors */
                --text-primary: #F8FAFC;
                --text-secondary: #94A3B8;
                --text-tertiary: #64748B;
                --text-inverse: #0F172A;

                /* Border Colors */
                --border-default: rgba(248, 250, 252, 0.08);
                --border-hover: rgba(248, 250, 252, 0.16);

                /* Primary - Brighter for dark mode */
                --primary: #3B82F6;
                --primary-hover: #60A5FA;
                --primary-light: rgba(59, 130, 246, 0.16);
                --primary-glow: rgba(59, 130, 246, 0.32);

                /* Accent */
                --accent: #FBBF24;
                --accent-glow: rgba(251, 191, 36, 0.32);

                /* Status Colors - Dark mode */
                --success: #34D399;
                --success-light: rgba(52, 211, 153, 0.16);
                --success-glow: rgba(52, 211, 153, 0.32);

                --danger: #F87171;
                --danger-hover: #FCA5A5;
                --danger-light: rgba(248, 113, 113, 0.16);
                --danger-glow: rgba(248, 113, 113, 0.32);

                /* Progress Ring */
                --ring-bg: rgba(248, 250, 252, 0.08);

                /* Legacy compatibility */
                --bg: var(--bg-primary);
                --card-bg: var(--bg-tertiary);
                --text: var(--text-primary);
                --border: var(--border-default);
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        body {
            font-family: var(--font-sans);
            font-size: var(--text-base);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            padding: var(--space-xl);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-image: radial-gradient(ellipse 80% 50% at 50% -20%, var(--primary-light) 0%, transparent 50%);
        }

        @media (prefers-color-scheme: dark) {
            body {
                background-image: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(59, 130, 246, 0.08) 0%, transparent 50%);
            }
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
        }

        h1 {
            font-size: var(--text-2xl);
            font-weight: 600;
            letter-spacing: -0.02em;
            margin-bottom: var(--space-2xl);
            text-align: center;
        }

        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            padding: var(--space-2xl);
            margin-bottom: var(--space-lg);
            box-shadow: var(--glass-shadow);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            pointer-events: none;
        }

        @media (prefers-color-scheme: dark) {
            .card::before {
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            }
        }

        /* Glass fallback for older browsers */
        @supports not (backdrop-filter: blur(20px)) {
            .card {
                background: var(--bg-tertiary);
            }
        }

        .form-group {
            margin-bottom: var(--space-lg);
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-size: var(--text-sm);
            font-weight: 500;
            margin-bottom: var(--space-sm);
            color: var(--text-secondary);
        }

        input[type="text"],
        input[type="password"] {
            width: 100%;
            height: 48px;
            padding: 0 var(--space-lg);
            font-family: var(--font-sans);
            font-size: var(--text-base);
            border: 1.5px solid var(--border-default);
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
            color: var(--text-primary);
            outline: none;
            transition:
                border-color var(--transition-fast) var(--ease-out),
                box-shadow var(--transition-fast) var(--ease-out),
                background-color var(--transition-fast) var(--ease-out);
        }

        input::placeholder {
            color: var(--text-tertiary);
        }

        input:hover {
            border-color: var(--border-hover);
        }

        input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-glow);
            background: var(--bg-tertiary);
        }

        #key-secret {
            font-family: var(--font-mono);
            font-size: var(--text-sm);
            letter-spacing: 0.02em;
        }

        button {
            font-family: var(--font-sans);
            font-size: var(--text-sm);
            font-weight: 500;
            padding: var(--space-md) var(--space-xl);
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            transition:
                background-color var(--transition-fast) var(--ease-out),
                transform var(--transition-fast) var(--ease-out),
                box-shadow var(--transition-fast) var(--ease-out);
        }

        .btn-primary {
            background: var(--primary);
            color: var(--text-inverse);
            width: 100%;
            height: 48px;
            box-shadow: 0 2px 8px var(--primary-glow);
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            box-shadow: 0 4px 16px var(--primary-glow);
            transform: translateY(-1px);
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px var(--primary-glow);
        }

        .btn-danger {
            background: var(--danger-light);
            color: var(--danger);
            padding: var(--space-sm) var(--space-md);
            font-size: var(--text-xs);
        }

        .btn-danger:hover {
            background: var(--danger);
            color: var(--text-inverse);
            box-shadow: 0 2px 8px var(--danger-glow);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-default);
        }

        .btn-secondary:hover {
            background: var(--border-default);
            border-color: var(--border-hover);
        }

        .token-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-lg) var(--space-xl);
            background: var(--glass-bg);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-md);
            cursor: pointer;
            transition:
                transform var(--transition-fast) var(--ease-out),
                box-shadow var(--transition-fast) var(--ease-out),
                border-color var(--transition-fast) var(--ease-out);
            position: relative;
            overflow: hidden;
        }

        .token-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: var(--space-xl);
            right: var(--space-xl);
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            pointer-events: none;
        }

        @media (prefers-color-scheme: dark) {
            .token-item::before {
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.08), transparent);
            }
        }

        .token-item:hover {
            transform: translateY(-2px);
            box-shadow:
                0 8px 24px rgba(0, 0, 0, 0.08),
                0 0 0 1px var(--border-hover);
            border-color: var(--border-hover);
        }

        @media (prefers-color-scheme: dark) {
            .token-item:hover {
                box-shadow:
                    0 8px 24px rgba(0, 0, 0, 0.32),
                    0 0 0 1px var(--border-hover);
            }
        }

        .token-item:active {
            transform: translateY(0);
        }

        .token-item.copied-flash {
            animation: copy-flash var(--transition-slow) var(--ease-out);
        }

        @keyframes copy-flash {
            0% { box-shadow: 0 0 0 0 var(--success-glow); }
            50% { box-shadow: 0 0 0 8px var(--success-glow); }
            100% { box-shadow: 0 0 0 0 var(--success-glow); }
        }

        @supports not (backdrop-filter: blur(16px)) {
            .token-item {
                background: var(--bg-tertiary);
            }
        }

        .token-info {
            flex: 1;
            min-width: 0;
        }

        .token-name {
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: var(--space-xs);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .token-code {
            font-family: var(--font-mono);
            font-size: var(--text-code);
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: 0.15em;
            font-variant-numeric: tabular-nums;
            word-spacing: var(--space-sm);
        }

        .token-actions {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            margin-left: var(--space-lg);
        }

        .progress-ring {
            width: 44px;
            height: 44px;
            flex-shrink: 0;
        }

        .progress-ring circle {
            fill: none;
            stroke-width: 3;
            stroke-linecap: round;
        }

        .progress-ring .bg {
            stroke: var(--ring-bg);
        }

        .progress-ring .progress {
            stroke: var(--ring-progress);
            transform: rotate(-90deg);
            transform-origin: center;
            transition: stroke-dashoffset 1s linear, stroke var(--transition-fast) var(--ease-out);
        }

        .progress-ring.warning .progress {
            stroke: var(--ring-warning);
        }

        .progress-ring.critical .progress {
            stroke: var(--ring-critical);
            animation: pulse-ring 0.5s ease-in-out infinite alternate;
        }

        @keyframes pulse-ring {
            from { opacity: 1; }
            to { opacity: 0.6; }
        }

        .progress-text {
            font-family: var(--font-mono);
            font-size: var(--text-xs);
            font-weight: 500;
            fill: var(--text-secondary);
            text-anchor: middle;
            dominant-baseline: middle;
        }

        .progress-ring.warning .progress-text {
            fill: var(--ring-warning);
        }

        .progress-ring.critical .progress-text {
            fill: var(--ring-critical);
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: var(--space-3xl) var(--space-xl);
            color: var(--text-tertiary);
        }

        .empty-state::before {
            content: '';
            display: block;
            width: 64px;
            height: 64px;
            margin: 0 auto var(--space-lg);
            background: var(--text-tertiary);
            opacity: 0.3;
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5'%3E%3Crect x='3' y='3' width='7' height='7' rx='1'%3E%3C/rect%3E%3Crect x='14' y='3' width='7' height='7' rx='1'%3E%3C/rect%3E%3Crect x='14' y='14' width='7' height='7' rx='1'%3E%3C/rect%3E%3Crect x='3' y='14' width='7' height='7' rx='1'%3E%3C/rect%3E%3C/svg%3E") center/contain no-repeat;
            -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='1.5'%3E%3Crect x='3' y='3' width='7' height='7' rx='1'%3E%3C/rect%3E%3Crect x='14' y='3' width='7' height='7' rx='1'%3E%3C/rect%3E%3Crect x='14' y='14' width='7' height='7' rx='1'%3E%3C/rect%3E%3Crect x='3' y='14' width='7' height='7' rx='1'%3E%3C/rect%3E%3C/svg%3E") center/contain no-repeat;
        }

        .empty-state p:first-of-type {
            font-size: var(--text-lg);
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: var(--space-sm);
        }

        .empty-state p:last-of-type {
            font-size: var(--text-sm);
        }

        .hidden {
            display: none !important;
        }

        .copied {
            position: fixed;
            top: var(--space-xl);
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
            background: var(--glass-bg);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            color: var(--success);
            padding: var(--space-md) var(--space-xl);
            border-radius: var(--radius-full);
            border: 1px solid var(--success-light);
            font-size: var(--text-sm);
            font-weight: 500;
            box-shadow:
                0 8px 24px rgba(0, 0, 0, 0.08),
                0 0 0 1px var(--success-glow);
            opacity: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            transition:
                transform var(--transition-slow) var(--ease-spring),
                opacity var(--transition-normal) var(--ease-out);
        }

        .copied::before {
            content: '';
            width: 16px;
            height: 16px;
            background: var(--success);
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E") center/contain no-repeat;
            -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E") center/contain no-repeat;
        }

        @media (prefers-color-scheme: dark) {
            .copied {
                box-shadow:
                    0 8px 24px rgba(0, 0, 0, 0.32),
                    0 0 0 1px var(--success-glow);
            }
        }

        .copied.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-2xl);
            padding: 0 var(--space-xs);
        }

        .header-actions h1 {
            font-size: var(--text-xl);
            margin-bottom: 0;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            background: transparent;
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
        }

        .btn-icon:hover {
            background: var(--border-default);
            color: var(--text-primary);
        }

        .btn-icon svg {
            width: 22px;
            height: 22px;
        }

        .error {
            display: flex;
            align-items: flex-start;
            gap: var(--space-sm);
            color: var(--danger);
            font-size: var(--text-sm);
            margin-top: var(--space-sm);
            padding: var(--space-sm) var(--space-md);
            background: var(--danger-light);
            border-radius: var(--radius-sm);
        }

        .error::before {
            content: '';
            flex-shrink: 0;
            width: 16px;
            height: 16px;
            margin-top: 1px;
            background: var(--danger);
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'%3E%3Ccircle cx='12' cy='12' r='10'%3E%3C/circle%3E%3Cline x1='12' y1='8' x2='12' y2='12'%3E%3C/line%3E%3Cline x1='12' y1='16' x2='12.01' y2='16'%3E%3C/line%3E%3C/svg%3E") center/contain no-repeat;
            -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'%3E%3Ccircle cx='12' cy='12' r='10'%3E%3C/circle%3E%3Cline x1='12' y1='8' x2='12' y2='12'%3E%3C/line%3E%3Cline x1='12' y1='16' x2='12.01' y2='16'%3E%3C/line%3E%3C/svg%3E") center/contain no-repeat;
        }

        .footer-actions {
            display: flex;
            justify-content: center;
            gap: var(--space-md);
            margin-top: var(--space-2xl);
            padding-top: var(--space-lg);
        }

        .footer-actions .btn-secondary {
            min-width: 80px;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-xl);
            z-index: 100;
            animation: overlay-fade-in var(--transition-normal) var(--ease-out);
        }

        @keyframes overlay-fade-in {
            from {
                opacity: 0;
                backdrop-filter: blur(0);
            }
            to {
                opacity: 1;
                backdrop-filter: blur(4px);
            }
        }

        @media (prefers-color-scheme: dark) {
            .modal-overlay {
                background: rgba(0, 0, 0, 0.6);
            }
        }

        .modal {
            background: var(--glass-bg);
            backdrop-filter: blur(24px) saturate(180%);
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            padding: var(--space-2xl);
            width: 100%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow:
                0 24px 48px rgba(0, 0, 0, 0.12),
                0 0 0 1px var(--glass-border);
            animation: modal-slide-up var(--transition-slow) var(--ease-spring);
        }

        @keyframes modal-slide-up {
            from {
                opacity: 0;
                transform: translateY(16px) scale(0.96);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @media (prefers-color-scheme: dark) {
            .modal {
                box-shadow:
                    0 24px 48px rgba(0, 0, 0, 0.4),
                    0 0 0 1px var(--glass-border);
            }
        }

        @supports not (backdrop-filter: blur(24px)) {
            .modal {
                background: var(--bg-tertiary);
            }
        }

        .modal h2 {
            font-size: var(--text-lg);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-lg);
            text-align: center;
        }

        .modal-actions {
            display: flex;
            gap: var(--space-md);
            margin-top: var(--space-2xl);
        }

        .modal-actions button {
            flex: 1;
        }

        .input-tabs {
            display: flex;
            gap: 0;
            margin-bottom: var(--space-lg);
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            padding: var(--space-xs);
        }

        .input-tabs button {
            flex: 1;
            padding: var(--space-sm) var(--space-md);
            background: transparent;
            border: none;
            border-radius: calc(var(--radius-sm) - 2px);
            color: var(--text-secondary);
            font-size: var(--text-sm);
            font-weight: 500;
            cursor: pointer;
            transition:
                background-color var(--transition-fast) var(--ease-out),
                color var(--transition-fast) var(--ease-out);
        }

        .input-tabs button:hover {
            color: var(--text-primary);
        }

        .input-tabs button.active {
            background: var(--bg-tertiary);
            color: var(--primary);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        @media (prefers-color-scheme: dark) {
            .input-tabs button.active {
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.24);
            }
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        #qr-camera-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1;
            background: #000;
            border-radius: var(--radius-md);
            overflow: hidden;
            margin-bottom: var(--space-md);
        }

        #qr-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #qr-canvas {
            display: none;
        }

        .scan-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60%;
            height: 60%;
            border: 2px solid var(--primary);
            border-radius: var(--radius-sm);
            pointer-events: none;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.3);
        }

        #qr-camera-status {
            text-align: center;
            font-size: var(--text-sm);
            color: var(--text-secondary);
            margin-bottom: var(--space-md);
        }

        .upload-zone {
            border: 2px dashed var(--border-default);
            border-radius: var(--radius-md);
            padding: var(--space-3xl) var(--space-xl);
            text-align: center;
            cursor: pointer;
            transition:
                border-color var(--transition-fast) var(--ease-out),
                background-color var(--transition-fast) var(--ease-out);
            color: var(--text-secondary);
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .upload-zone p:first-child {
            font-weight: 500;
            margin-bottom: var(--space-sm);
        }

        .upload-zone p:last-child {
            font-size: var(--text-xs);
            color: var(--text-tertiary);
        }

        #qr-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: var(--radius-sm);
            margin-top: var(--space-md);
            display: none;
        }

        #qr-preview.show {
            display: block;
        }

        .btn-scan {
            width: 100%;
            margin-top: var(--space-md);
        }

        /* Links */
        a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            transition: color var(--transition-fast) var(--ease-out);
        }

        a:hover {
            color: var(--primary-hover);
        }

        /* ========================================
           Mobile Performance Optimization
           ======================================== */

        /* Add will-change for frequently animated elements */
        .progress-ring .progress {
            will-change: stroke-dashoffset;
        }

        /* Mobile: Disable expensive backdrop-filter */
        @media (max-width: 768px) {
            .card,
            .token-item,
            .modal,
            .copied {
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
            }

            .card {
                background: var(--bg-tertiary);
                border: 1px solid var(--border-default);
            }

            .token-item {
                background: var(--bg-tertiary);
                border: 1px solid var(--border-default);
            }

            .modal {
                background: var(--bg-tertiary);
            }

            .copied {
                background: var(--bg-tertiary);
            }

            /* Remove decorative pseudo-elements on mobile */
            .card::before,
            .token-item::before {
                display: none;
            }

            /* Disable hover lift effect (not useful on touch) */
            .token-item:hover {
                transform: none;
                box-shadow: none;
            }

            .token-item:active {
                background: var(--border-default);
            }

            .btn-primary:hover {
                transform: none;
            }

            /* Simplify copy flash animation */
            .token-item.copied-flash {
                animation: none;
                background: var(--success-light);
                transition: background-color var(--transition-fast) var(--ease-out);
            }

            /* Disable progress ring pulse on mobile */
            .progress-ring.critical .progress {
                animation: none;
                opacity: 1;
            }

            /* Simplify modal animation */
            .modal-overlay {
                animation: none;
            }

            .modal {
                animation: none;
            }

            /* Reduce shadow complexity */
            .btn-primary {
                box-shadow: none;
            }

            .btn-primary:hover {
                box-shadow: none;
            }

            /* Simplify body background */
            body {
                background-image: none;
            }
        }

        /* Touch-friendly tap targets (minimum 44px) */
        @media (pointer: coarse) {
            .btn-icon {
                min-width: 44px;
                min-height: 44px;
            }

            .btn-danger {
                min-height: 36px;
                padding: var(--space-sm) var(--space-md);
            }

            .input-tabs button {
                min-height: 40px;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js" integrity="sha384-b5Ya4Bq3qCyz39m2ISh+4DxjAIljdeFwK/BsXLuj9gugaNwAcj/ia15fxNZL9Nlx" crossorigin="anonymous"></script>
</head>
<body>
    <div class="container">
        <!-- Unlock Screen -->
        <div id="unlock-screen">
            <h1>2FA Authenticator</h1>
            <div class="card">
                <div id="setup-password" class="hidden">
                    <div class="form-group">
                        <label for="new-password">设置主密码</label>
                        <input type="password" id="new-password" placeholder="输入密码">
                    </div>
                    <div class="form-group">
                        <label for="confirm-password">确认密码</label>
                        <input type="password" id="confirm-password" placeholder="再次输入密码">
                    </div>
                    <div id="setup-error" class="error hidden"></div>
                    <div class="form-group">
                        <button class="btn-primary" onclick="setupPassword()">设置密码</button>
                    </div>
                    <div style="text-align: center; margin-top: 12px;">
                        <a href="javascript:showLoginForm()" style="color: var(--primary); font-size: 14px;">已有账户? 直接登录</a>
                    </div>
                </div>
                <div id="enter-password">
                    <div class="form-group">
                        <label for="password">主密码</label>
                        <input type="password" id="password" placeholder="输入密码" onkeypress="if(event.key==='Enter')unlock()">
                    </div>
                    <div id="unlock-error" class="error hidden"></div>
                    <div class="form-group">
                        <button class="btn-primary" onclick="unlock()">解锁</button>
                    </div>
                    <div style="text-align: center; margin-top: 12px;">
                        <a href="javascript:showSetupForm()" style="color: var(--primary); font-size: 14px;">首次使用? 创建账户</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main App -->
        <div id="main-app" class="hidden">
            <div class="header-actions">
                <button class="btn-icon" onclick="logout()" title="退出">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                </button>
                <h1>2FA Authenticator</h1>
                <button class="btn-icon" onclick="showAddModal()" title="添加密钥">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                </button>
            </div>
            <div id="token-list"></div>
            <div id="empty-state" class="empty-state hidden">
                <p>还没有添加密钥</p>
                <p>点击 + 添加你的第一个 2FA 密钥</p>
            </div>
            <div class="footer-actions">
                <button class="btn-secondary" onclick="importKeys()">导入</button>
                <button class="btn-secondary" onclick="exportKeys()">导出</button>
            </div>
        </div>

        <!-- Add Modal -->
        <div id="add-modal" class="modal-overlay hidden">
            <div class="modal">
                <h2>添加新密钥</h2>
                <div class="input-tabs">
                    <button class="active" onclick="switchInputTab('manual')">手动输入</button>
                    <button onclick="switchInputTab('scan')">扫描</button>
                    <button onclick="switchInputTab('upload')">上传</button>
                </div>
                <div class="tab-content active" id="tab-manual">
                    <div class="form-group">
                        <label for="key-name">名称</label>
                        <input type="text" id="key-name" placeholder="例如: GitHub">
                    </div>
                    <div class="form-group">
                        <label for="key-secret">密钥</label>
                        <input type="text" id="key-secret" placeholder="Base32 密钥">
                    </div>
                </div>
                <div class="tab-content" id="tab-scan">
                    <div id="qr-camera-container">
                        <video id="qr-video" playsinline></video>
                        <canvas id="qr-canvas"></canvas>
                        <div class="scan-guide"></div>
                    </div>
                    <div id="qr-camera-status">点击下方按钮启动摄像头</div>
                    <button class="btn-primary btn-scan" onclick="startQrScanner()">启动摄像头</button>
                </div>
                <div class="tab-content" id="tab-upload">
                    <div class="upload-zone" id="upload-zone">
                        <p>点击选择、拖拽或粘贴图片</p>
                        <p>支持 PNG / JPG / WEBP</p>
                    </div>
                    <input type="file" id="qr-upload" accept="image/png,image/jpeg,image/webp" hidden>
                    <img id="qr-preview" alt="QR code preview">
                </div>
                <div id="add-error" class="error hidden"></div>
                <div class="modal-actions" id="modal-actions-manual">
                    <button class="btn-secondary" onclick="hideAddModal()">取消</button>
                    <button class="btn-primary" onclick="addKey()">添加</button>
                </div>
                <div class="modal-actions hidden" id="modal-actions-other">
                    <button class="btn-secondary" onclick="hideAddModal()" style="width: 100%;">取消</button>
                </div>
            </div>
        </div>

        <!-- Copied Toast -->
        <div id="copied-toast" class="copied">已复制</div>
    </div>

    <script>
        // State
        let masterKey = null;
        let keys = [];
        let updateInterval = null;
        let currentKeyHash = null;
        let currentSalt = null;

        // QR Scanner State
        let qrStream = null;
        let qrScanInterval = null;

        // ============ Utils ============
        function generateId() {
            if (typeof crypto.randomUUID === 'function') {
                return crypto.randomUUID();
            }
            return `${Date.now()}-${Math.random().toString(36).substring(2, 11)}`;
        }

        // ============ Session ============
        const SESSION_KEY = '2fa_session';

        async function exportKey(key) {
            const exported = await crypto.subtle.exportKey('raw', key);
            return btoa(String.fromCharCode(...new Uint8Array(exported)));
        }

        async function importKey(keyStr) {
            const keyData = Uint8Array.from(atob(keyStr), c => c.charCodeAt(0));
            return crypto.subtle.importKey(
                'raw', keyData, { name: 'AES-GCM', length: 256 }, true, ['encrypt', 'decrypt']
            );
        }

        function saveSession(keyStr, keyHash, salt) {
            sessionStorage.setItem(SESSION_KEY, JSON.stringify({ keyStr, keyHash, salt }));
        }

        function loadSession() {
            const data = sessionStorage.getItem(SESSION_KEY);
            return data ? JSON.parse(data) : null;
        }

        function clearSession() {
            sessionStorage.removeItem(SESSION_KEY);
        }

        // ============ PBKDF2 Iterations ============
        const PBKDF2_ITERATIONS = {
            V1_KEY_HASH: 50000,
            V1_DERIVE_KEY: 100000,
            V2: 600000
        };
        const CURRENT_VERSION = 2;

        // ============ API Client ============
        async function apiGet(keyHash) {
            const response = await fetch(`/api/data?key=${encodeURIComponent(keyHash)}`);
            if (!response.ok) throw new Error('API Error');
            return response.json();
        }

        async function apiSave(keyHash, encryptedData, salt, version = CURRENT_VERSION) {
            const response = await fetch('/api/data', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: keyHash, data: encryptedData, salt: salt, version: version }),
            });
            if (!response.ok) throw new Error('API Error');
            return response.json();
        }

        async function apiDelete(keyHash) {
            const response = await fetch(`/api/data?key=${encodeURIComponent(keyHash)}`, {
                method: 'DELETE',
            });
            if (!response.ok) throw new Error('API Error');
            return response.json();
        }

        // ============ Key Hash ============
        async function deriveKeyHash(password, iterations = PBKDF2_ITERATIONS.V2) {
            const enc = new TextEncoder();
            const fixedSalt = enc.encode('2fa-sync-v1-key-hash');

            const keyMaterial = await crypto.subtle.importKey(
                'raw', enc.encode(password), 'PBKDF2', false, ['deriveBits']
            );

            const bits = await crypto.subtle.deriveBits(
                { name: 'PBKDF2', salt: fixedSalt, iterations: iterations, hash: 'SHA-256' },
                keyMaterial, 256
            );

            return Array.from(new Uint8Array(bits))
                .map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // ============ Salt ============
        function generateSalt() {
            const salt = crypto.getRandomValues(new Uint8Array(16));
            return btoa(String.fromCharCode(...salt));
        }

        function decodeSalt(saltStr) {
            return Uint8Array.from(atob(saltStr), c => c.charCodeAt(0));
        }

        // ============ Base32 ============
        const BASE32_CHARS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';

        function base32Decode(str) {
            str = str.toUpperCase().replace(/[^A-Z2-7]/g, '');
            const bits = [];
            for (const char of str) {
                const val = BASE32_CHARS.indexOf(char);
                if (val === -1) continue;
                bits.push(...val.toString(2).padStart(5, '0').split('').map(Number));
            }
            const bytes = [];
            for (let i = 0; i + 8 <= bits.length; i += 8) {
                bytes.push(parseInt(bits.slice(i, i + 8).join(''), 2));
            }
            return new Uint8Array(bytes);
        }

        // ============ OTPAuth URI ============
        function parseOtpauthUri(uri) {
            if (!uri || !uri.startsWith('otpauth://totp/')) {
                return null;
            }
            try {
                const url = new URL(uri);
                const secret = url.searchParams.get('secret');
                if (!secret) return null;

                const label = decodeURIComponent(url.pathname.slice(6));
                const issuer = url.searchParams.get('issuer');
                let name = issuer || (label.includes(':') ? label.split(':')[0] : label) || '未命名';

                return { name: name.trim(), secret: secret.replace(/\s+/g, '').toUpperCase() };
            } catch {
                return null;
            }
        }

        // ============ TOTP ============
        async function generateTOTP(secret, time = Date.now()) {
            const counter = Math.floor(time / 30000);
            const counterBytes = new Uint8Array(8);
            let temp = counter;
            for (let i = 7; i >= 0; i--) {
                counterBytes[i] = temp & 0xff;
                temp = Math.floor(temp / 256);
            }

            const keyData = base32Decode(secret);
            const key = await crypto.subtle.importKey(
                'raw',
                keyData,
                { name: 'HMAC', hash: 'SHA-1' },
                false,
                ['sign']
            );

            const signature = await crypto.subtle.sign('HMAC', key, counterBytes);
            const hash = new Uint8Array(signature);

            const offset = hash[hash.length - 1] & 0x0f;
            const binary =
                ((hash[offset] & 0x7f) << 24) |
                ((hash[offset + 1] & 0xff) << 16) |
                ((hash[offset + 2] & 0xff) << 8) |
                (hash[offset + 3] & 0xff);

            return (binary % 1000000).toString().padStart(6, '0');
        }

        // ============ Encryption ============
        async function deriveKey(password, salt, iterations = PBKDF2_ITERATIONS.V2) {
            const enc = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey(
                'raw',
                enc.encode(password),
                'PBKDF2',
                false,
                ['deriveKey']
            );
            return crypto.subtle.deriveKey(
                {
                    name: 'PBKDF2',
                    salt: salt,
                    iterations: iterations,
                    hash: 'SHA-256'
                },
                keyMaterial,
                { name: 'AES-GCM', length: 256 },
                true,
                ['encrypt', 'decrypt']
            );
        }

        async function encrypt(data, key) {
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const enc = new TextEncoder();
            const encrypted = await crypto.subtle.encrypt(
                { name: 'AES-GCM', iv: iv },
                key,
                enc.encode(JSON.stringify(data))
            );
            const combined = new Uint8Array(iv.length + encrypted.byteLength);
            combined.set(iv);
            combined.set(new Uint8Array(encrypted), iv.length);
            return btoa(String.fromCharCode(...combined));
        }

        async function decrypt(encryptedData, key) {
            const combined = Uint8Array.from(atob(encryptedData), c => c.charCodeAt(0));
            const iv = combined.slice(0, 12);
            const data = combined.slice(12);
            const decrypted = await crypto.subtle.decrypt(
                { name: 'AES-GCM', iv: iv },
                key,
                data
            );
            return JSON.parse(new TextDecoder().decode(decrypted));
        }

        // ============ Cloud Storage ============
        async function saveKeys() {
            if (!masterKey || !currentKeyHash) return;
            const encrypted = await encrypt(keys, masterKey);
            await apiSave(currentKeyHash, encrypted, currentSalt);
        }

        async function loadKeysFromCloud(keyHash) {
            const result = await apiGet(keyHash);
            if (!result.exists) {
                return { exists: false, data: null, salt: null };
            }

            let stored;
            try {
                stored = JSON.parse(result.data);
            } catch (e) {
                console.error('Invalid server response format:', e);
                throw new Error('服务器响应格式错误');
            }

            if (!stored || typeof stored.encryptedData !== 'string' || typeof stored.salt !== 'string') {
                console.error('Missing required fields in server response');
                throw new Error('服务器响应数据不完整');
            }

            return { exists: true, data: stored.encryptedData, salt: stored.salt };
        }

        // ============ UI ============
        function showError(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.classList.remove('hidden');
        }

        function hideError(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }

        function showSetupForm() {
            document.getElementById('setup-password').classList.remove('hidden');
            document.getElementById('enter-password').classList.add('hidden');
        }

        function showLoginForm() {
            document.getElementById('setup-password').classList.add('hidden');
            document.getElementById('enter-password').classList.remove('hidden');
        }

        function validatePassword(password) {
            if (password.length < 8) {
                return { valid: false, error: '密码至少需要8个字符' };
            }
            if (!/[a-zA-Z]/.test(password)) {
                return { valid: false, error: '密码需要包含至少一个字母' };
            }
            if (!/[0-9]/.test(password)) {
                return { valid: false, error: '密码需要包含至少一个数字' };
            }
            return { valid: true };
        }

        async function setupPassword() {
            const password = document.getElementById('new-password').value;
            const confirm = document.getElementById('confirm-password').value;

            hideError('setup-error');

            const validation = validatePassword(password);
            if (!validation.valid) {
                showError('setup-error', validation.error);
                return;
            }

            if (password !== confirm) {
                showError('setup-error', '两次密码不一致');
                return;
            }

            try {
                const oldKeyHash = await deriveKeyHash(password, PBKDF2_ITERATIONS.V1_KEY_HASH);
                const oldCloudData = await loadKeysFromCloud(oldKeyHash);
                if (oldCloudData.exists) {
                    showError('setup-error', '此密码已被使用，请直接登录');
                    return;
                }

                currentKeyHash = await deriveKeyHash(password, PBKDF2_ITERATIONS.V2);

                const cloudData = await loadKeysFromCloud(currentKeyHash);
                if (cloudData.exists) {
                    showError('setup-error', '此密码已被使用，请换一个密码或直接登录');
                    return;
                }

                currentSalt = generateSalt();
                masterKey = await deriveKey(password, decodeSalt(currentSalt), PBKDF2_ITERATIONS.V2);
                keys = [];
                await saveKeys();

                saveSession(await exportKey(masterKey), currentKeyHash, currentSalt);
                showMainApp();
            } catch (error) {
                showError('setup-error', '网络错误，请重试');
            }
        }

        async function unlock() {
            const password = document.getElementById('password').value;
            hideError('unlock-error');

            if (!password) {
                showError('unlock-error', '请输入密码');
                return;
            }

            try {
                const oldKeyHash = await deriveKeyHash(password, PBKDF2_ITERATIONS.V1_KEY_HASH);
                const oldCloudData = await loadKeysFromCloud(oldKeyHash);

                if (oldCloudData.exists) {
                    const migrateResult = await migrateFromV1(password, oldKeyHash, oldCloudData);
                    if (!migrateResult.success) {
                        showError('unlock-error', migrateResult.error);
                        return;
                    }
                    saveSession(await exportKey(masterKey), currentKeyHash, currentSalt);
                    showMainApp();
                    return;
                }

                currentKeyHash = await deriveKeyHash(password, PBKDF2_ITERATIONS.V2);
                const cloudData = await loadKeysFromCloud(currentKeyHash);

                if (!cloudData.exists) {
                    showError('unlock-error', '密码错误或账户不存在');
                    return;
                }

                currentSalt = cloudData.salt;
                masterKey = await deriveKey(password, decodeSalt(currentSalt), PBKDF2_ITERATIONS.V2);

                try {
                    keys = await decrypt(cloudData.data, masterKey);
                } catch {
                    showError('unlock-error', '密码错误');
                    masterKey = null;
                    currentKeyHash = null;
                    currentSalt = null;
                    return;
                }

                saveSession(await exportKey(masterKey), currentKeyHash, currentSalt);
                showMainApp();
            } catch (error) {
                showError('unlock-error', '网络错误，请重试');
            }
        }

        async function migrateFromV1(password, oldKeyHash, oldCloudData) {
            try {
                const oldKey = await deriveKey(password, decodeSalt(oldCloudData.salt), PBKDF2_ITERATIONS.V1_DERIVE_KEY);
                try {
                    keys = await decrypt(oldCloudData.data, oldKey);
                } catch {
                    return { success: false, error: '密码错误' };
                }

                currentKeyHash = await deriveKeyHash(password, PBKDF2_ITERATIONS.V2);
                currentSalt = generateSalt();
                masterKey = await deriveKey(password, decodeSalt(currentSalt), PBKDF2_ITERATIONS.V2);

                const encrypted = await encrypt(keys, masterKey);
                await apiSave(currentKeyHash, encrypted, currentSalt, CURRENT_VERSION);

                await apiDelete(oldKeyHash);

                return { success: true };
            } catch (error) {
                return { success: false, error: '迁移失败，请重试' };
            }
        }

        function showMainApp() {
            document.getElementById('unlock-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            renderKeys();
            startUpdateInterval();
        }

        function logout() {
            if (updateInterval) clearInterval(updateInterval);
            clearSession();
            masterKey = null;
            keys = [];
            currentKeyHash = null;
            currentSalt = null;
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('unlock-screen').classList.remove('hidden');
            document.getElementById('password').value = '';
            showLoginForm();
        }

        function showAddModal() {
            document.getElementById('key-name').value = '';
            document.getElementById('key-secret').value = '';
            hideError('add-error');
            document.getElementById('add-modal').classList.remove('hidden');
        }

        function hideAddModal() {
            stopQrScanner();
            document.getElementById('qr-preview').classList.remove('show');
            document.getElementById('add-modal').classList.add('hidden');
        }

        // ============ Tab Switching ============
        function switchInputTab(tab) {
            stopQrScanner();
            clearUploadPreview();

            const tabs = document.querySelectorAll('.input-tabs button');
            const contents = document.querySelectorAll('.tab-content');
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));

            const activeTab = document.querySelector(`.input-tabs button[onclick*="${tab}"]`);
            const activeContent = document.getElementById(`tab-${tab}`);
            if (activeTab) activeTab.classList.add('active');
            if (activeContent) activeContent.classList.add('active');

            const actionsManual = document.getElementById('modal-actions-manual');
            const actionsOther = document.getElementById('modal-actions-other');
            if (tab === 'manual') {
                actionsManual.classList.remove('hidden');
                actionsOther.classList.add('hidden');
            } else {
                actionsManual.classList.add('hidden');
                actionsOther.classList.remove('hidden');
            }
        }

        function clearUploadPreview() {
            const preview = document.getElementById('qr-preview');
            if (preview.src && preview.src.startsWith('blob:')) {
                URL.revokeObjectURL(preview.src);
            }
            preview.classList.remove('show');
            preview.src = '';
        }

        // ============ QR Scanner ============
        async function startQrScanner() {
            const video = document.getElementById('qr-video');
            const canvas = document.getElementById('qr-canvas');
            const status = document.getElementById('qr-camera-status');
            hideError('add-error');

            if (typeof jsQR === 'undefined') {
                showError('add-error', '二维码识别库加载失败, 请刷新页面重试');
                return;
            }

            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showError('add-error', '浏览器不支持摄像头访问');
                return;
            }

            status.textContent = '正在请求摄像头权限...';

            try {
                qrStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                video.srcObject = qrStream;
                await video.play();

                canvas.width = video.videoWidth || 640;
                canvas.height = video.videoHeight || 480;

                status.textContent = '扫描中...';
                qrScanInterval = setInterval(() => scanQrFrame(video, canvas), 200);
            } catch (err) {
                stopQrScanner();
                if (err.name === 'NotAllowedError') {
                    showError('add-error', '摄像头权限被拒绝, 请在浏览器设置中允许');
                } else if (err.name === 'NotFoundError') {
                    showError('add-error', '未检测到摄像头设备');
                } else {
                    console.error('Camera error:', err);
                    showError('add-error', '摄像头启动失败, 请检查设备和权限设置');
                }
                status.textContent = '摄像头启动失败';
            }
        }

        function stopQrScanner() {
            if (qrScanInterval) {
                clearInterval(qrScanInterval);
                qrScanInterval = null;
            }
            if (qrStream) {
                qrStream.getTracks().forEach(track => track.stop());
                qrStream = null;
            }
            const video = document.getElementById('qr-video');
            if (video) video.srcObject = null;
            const status = document.getElementById('qr-camera-status');
            if (status) status.textContent = '点击下方按钮启动摄像头';
        }

        function scanQrFrame(video, canvas) {
            if (!qrStream) return;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);

            if (code && code.data) {
                stopQrScanner();
                processQrCode(code.data);
            }
        }

        function processQrCode(data) {
            const parsed = parseOtpauthUri(data);
            if (!parsed) {
                showError('add-error', '仅支持 otpauth://totp/ 格式的二维码');
                return;
            }
            document.getElementById('key-name').value = parsed.name;
            document.getElementById('key-secret').value = parsed.secret;
            switchInputTab('manual');
        }

        // ============ Image Upload ============
        function setupUploadZone() {
            const zone = document.getElementById('upload-zone');
            const input = document.getElementById('qr-upload');

            zone.addEventListener('click', () => input.click());

            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });

            zone.addEventListener('dragleave', () => {
                zone.classList.remove('dragover');
            });

            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) handleQrUpload(file);
            });

            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) handleQrUpload(file);
                input.value = '';
            });

            document.addEventListener('paste', (e) => {
                const modal = document.getElementById('add-modal');
                const uploadTab = document.getElementById('tab-upload');
                if (modal.classList.contains('hidden') || !uploadTab.classList.contains('active')) {
                    return;
                }
                const items = e.clipboardData?.items;
                if (!items) return;
                for (const item of items) {
                    if (item.type.startsWith('image/')) {
                        const file = item.getAsFile();
                        if (file) handleQrUpload(file);
                        break;
                    }
                }
            });
        }

        function handleQrUpload(file) {
            hideError('add-error');
            const preview = document.getElementById('qr-preview');

            if (typeof jsQR === 'undefined') {
                showError('add-error', '二维码识别库加载失败, 请刷新页面重试');
                return;
            }

            if (!file.type.match(/^image\/(png|jpeg|webp)$/)) {
                showError('add-error', '仅支持 PNG/JPG/WEBP 格式图片');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                showError('add-error', '图片文件过大, 请选择小于 5MB 的图片');
                return;
            }

            clearUploadPreview();

            const previewUrl = URL.createObjectURL(file);
            preview.src = previewUrl;
            preview.classList.add('show');

            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);

                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);

                if (code && code.data) {
                    processQrCode(code.data);
                } else {
                    showError('add-error', '图片中未识别到二维码');
                }
                URL.revokeObjectURL(img.src);
            };

            img.onerror = () => {
                showError('add-error', '图片加载失败');
                URL.revokeObjectURL(img.src);
            };

            img.src = URL.createObjectURL(file);
        }

        async function addKey() {
            const name = document.getElementById('key-name').value.trim();
            const secret = document.getElementById('key-secret').value.trim();

            hideError('add-error');

            if (!name) {
                showError('add-error', '请输入名称');
                return;
            }

            if (!secret) {
                showError('add-error', '请输入密钥');
                return;
            }

            if (keys.some(k => k.name === name)) {
                showError('add-error', '该名称已存在');
                return;
            }

            try {
                await generateTOTP(secret);
            } catch {
                showError('add-error', '密钥格式无效');
                return;
            }

            keys.push({ id: generateId(), name, secret });
            await saveKeys();
            hideAddModal();
            renderKeys();
        }

        async function deleteKey(id) {
            if (!confirm('确定删除这个密钥吗?')) return;
            keys = keys.filter(k => String(k.id) !== String(id));
            await saveKeys();
            renderKeys();
        }

        function showToast(message) {
            const toast = document.getElementById('copied-toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 1500);
        }

        async function copyCode(code, tokenItem = null) {
            // Add copy flash animation
            if (tokenItem) {
                tokenItem.classList.add('copied-flash');
                setTimeout(() => tokenItem.classList.remove('copied-flash'), 300);
            }

            try {
                await navigator.clipboard.writeText(code);
                showToast('已复制');
            } catch (err) {
                console.error('Clipboard API failed:', err);
                const textarea = document.createElement('textarea');
                textarea.value = code;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                textarea.style.pointerEvents = 'none';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showToast('已复制');
                } catch {
                    showToast('复制失败');
                }
                document.body.removeChild(textarea);
            }
        }

        function exportKeys() {
            if (keys.length === 0) {
                alert('没有可导出的密钥');
                return;
            }
            const now = new Date();
            const pad = n => n.toString().padStart(2, '0');
            const exportedAt = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
            const exportData = {
                version: 1,
                exported_at: exportedAt,
                keys: keys.map(k => ({ name: k.name, secret: k.secret }))
            };
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `2fa-backup-${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        async function importKeys() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                if (file.size > 1024 * 1024) {
                    alert('文件过大, 请选择小于 1MB 的备份文件');
                    return;
                }
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    if (!data.keys || !Array.isArray(data.keys)) {
                        alert('无效的备份文件格式');
                        return;
                    }
                    const existingNames = new Set(keys.map(k => k.name));
                    let imported = 0;
                    let skipped = 0;
                    for (const item of data.keys) {
                        if (!item.name || !item.secret) continue;
                        if (existingNames.has(item.name)) {
                            skipped++;
                            continue;
                        }
                        try {
                            await generateTOTP(item.secret);
                            keys.push({ id: generateId(), name: item.name, secret: item.secret });
                            existingNames.add(item.name);
                            imported++;
                        } catch {
                            skipped++;
                        }
                    }
                    if (imported > 0) {
                        await saveKeys();
                        await renderKeys();
                    }
                    alert(`导入完成: ${imported} 个成功, ${skipped} 个跳过`);
                } catch {
                    alert('导入失败: 文件格式错误');
                }
            };
            input.click();
        }

        // Format 6-digit code as "xxx xxx" for readability
        function formatCode(code) {
            return code.slice(0, 3) + ' ' + code.slice(3);
        }

        // Get progress ring state class based on remaining time
        function getProgressRingClass(remaining) {
            if (remaining <= 5) return 'critical';
            if (remaining <= 10) return 'warning';
            return '';
        }

        // Track last remaining time to detect TOTP period reset
        let lastRemaining = -1;
        // Cache generated codes to avoid regenerating every second
        let cachedCodes = new Map();

        // Full render - rebuilds entire DOM (called on key changes or period reset)
        async function renderKeys() {
            const list = document.getElementById('token-list');
            const empty = document.getElementById('empty-state');

            if (keys.length === 0) {
                list.innerHTML = '';
                empty.classList.remove('hidden');
                cachedCodes.clear();
                return;
            }

            empty.classList.add('hidden');

            const now = Date.now();
            const remaining = 30 - Math.floor((now / 1000) % 30);
            const progress = (remaining / 30) * 100;
            const circumference = 2 * Math.PI * 15;
            const offset = circumference * (1 - progress / 100);
            const ringClass = getProgressRingClass(remaining);

            // Update cached codes
            cachedCodes.clear();
            let html = '';
            for (const key of keys) {
                const code = await generateTOTP(key.secret);
                cachedCodes.set(key.id, code);
                const formattedCode = formatCode(code);
                html += `
                    <div class="token-item" data-key-id="${escapeHtml(String(key.id))}">
                        <div class="token-info">
                            <div class="token-name">${escapeHtml(key.name)}</div>
                            <div class="token-code">${escapeHtml(formattedCode)}</div>
                        </div>
                        <div class="token-actions">
                            <svg class="progress-ring ${ringClass}" viewBox="0 0 36 36">
                                <circle class="bg" cx="18" cy="18" r="15"></circle>
                                <circle class="progress" cx="18" cy="18" r="15"
                                    stroke-dasharray="${circumference}"
                                    stroke-dashoffset="${offset}"></circle>
                                <text class="progress-text" x="18" y="18">${remaining}</text>
                            </svg>
                            <button class="btn-danger" data-action="delete">删除</button>
                        </div>
                    </div>
                `;
            }
            list.innerHTML = html;
            lastRemaining = remaining;
        }

        // Incremental update - only updates progress rings and checks for period reset
        async function updateDisplay() {
            if (keys.length === 0) return;

            const now = Date.now();
            const remaining = 30 - Math.floor((now / 1000) % 30);

            // Period reset detected (30 -> 29... -> 1 -> 30) - need full re-render for new codes
            if (remaining > lastRemaining && lastRemaining !== -1) {
                await renderKeys();
                return;
            }

            const progress = (remaining / 30) * 100;
            const circumference = 2 * Math.PI * 15;
            const offset = circumference * (1 - progress / 100);
            const ringClass = getProgressRingClass(remaining);

            // Update only the changing parts
            const rings = document.querySelectorAll('.progress-ring');
            rings.forEach(ring => {
                // Update class for warning/critical state
                ring.className = `progress-ring ${ringClass}`;

                // Update progress circle offset
                const progressCircle = ring.querySelector('.progress');
                if (progressCircle) {
                    progressCircle.setAttribute('stroke-dashoffset', offset);
                }

                // Update remaining text
                const text = ring.querySelector('.progress-text');
                if (text) {
                    text.textContent = remaining;
                }
            });

            lastRemaining = remaining;
        }

        function setupTokenListEvents() {
            const list = document.getElementById('token-list');
            list.addEventListener('click', (e) => {
                const tokenItem = e.target.closest('.token-item');
                if (!tokenItem) return;

                const keyId = tokenItem.dataset.keyId;

                if (e.target.closest('.token-info')) {
                    const code = tokenItem.querySelector('.token-code').textContent.replace(/\s/g, '');
                    copyCode(code, tokenItem);
                }

                if (e.target.closest('[data-action="delete"]')) {
                    deleteKey(keyId);
                }
            });
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function startUpdateInterval() {
            if (updateInterval) clearInterval(updateInterval);
            // Use incremental update instead of full re-render for better performance
            updateInterval = setInterval(updateDisplay, 1000);
        }

        // ============ Init ============
        async function init() {
            setupUploadZone();
            setupTokenListEvents();
            const session = loadSession();

            if (session) {
                try {
                    masterKey = await importKey(session.keyStr);
                    currentKeyHash = session.keyHash;
                    currentSalt = session.salt;

                    const cloudData = await loadKeysFromCloud(currentKeyHash);
                    if (cloudData.exists) {
                        keys = await decrypt(cloudData.data, masterKey);
                        showMainApp();
                        return;
                    }
                } catch {
                    clearSession();
                }
            }

            document.getElementById('setup-password').classList.add('hidden');
            document.getElementById('enter-password').classList.remove('hidden');
        }

        // ============ Page Lifecycle ============
        window.addEventListener('beforeunload', () => {
            stopQrScanner();
        });

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopQrScanner();
            }
        });

        init();
    </script>
</body>
</html>
